{"version":3,"sources":["../../src/peer-connection.js"],"names":["EventEmitter","WS","encode","decode","Credentials","CredentialsResponse","PeerRequest","PeerResponse","Unpeer","CloseError","Error","constructor","message","name","code","PeerError","peerId","CredentialsError","PeerConnection","id","address","maxPayloadLength","credentials","timeoutDuration","open","heartbeatInterval","ws","maxPayload","on","emit","setInterval","readyState","send","Uint8Array","reason","clearInterval","data","value","success","Promise","resolve","reject","onOpen","removeListener","onError","error","once","sendCredentials","sendPeerRequest","close","onClose","handleClose","clearTimeout","timeout","handleCredentialsResponse","setTimeout","Math","round","handlePeerResponse","unpeer"],"mappings":"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","sourcesContent":["// @flow\n\nimport EventEmitter from 'events';\nimport WS from 'ws';\n\nimport {\n  encode,\n  decode,\n  Credentials,\n  CredentialsResponse,\n  PeerRequest,\n  PeerResponse,\n  Unpeer,\n} from '@bunchtogether/braid-messagepack';\n\nclass CloseError extends Error {\n  declare code: number;\n  constructor(message:string) {\n    super(message);\n    this.name = 'CloseError';\n    this.code = 502;\n  }\n}\n\nclass PeerError extends Error {\n  declare code: number;\n  declare peerId: number | void;\n  constructor(message:string, code:number, peerId?: number) {\n    super(message);\n    this.name = 'PeerError';\n    this.code = code;\n    this.peerId = peerId;\n  }\n}\n\nclass CredentialsError extends Error {\n  declare code: number;\n  constructor(message:string, code:number) {\n    super(message);\n    this.name = 'CredentialsError';\n    this.code = code;\n  }\n}\n\nexport default class PeerConnection extends EventEmitter {\n  constructor(id: number, address:string, maxPayloadLength: number, credentials?:Object = {}) {\n    super();\n    this.id = id;\n    this.address = address;\n    this.maxPayloadLength = maxPayloadLength;\n    this.credentials = credentials;\n    this.timeoutDuration = 5000;\n  }\n\n  async open():Promise<number> {\n    let heartbeatInterval;\n\n    const ws = new WS(this.address, {\n      maxPayload: this.maxPayloadLength,\n    });\n\n    ws.on('error', () => {\n      this.emit('error', new Error(`Websocket error when connecting to ${this.address}, check the 'close' event for additional details`));\n    });\n\n    ws.on('open', () => {\n      this.emit('open');\n      this.ws = ws;\n      heartbeatInterval = setInterval(() => {\n        if (ws.readyState === 1) {\n          ws.send(new Uint8Array([0]));\n        }\n      }, 5000);\n    });\n\n    ws.on('close', (code: number, reason:string) => {\n      delete this.ws;\n      this.emit('close', code, reason);\n      clearInterval(heartbeatInterval);\n    });\n\n    ws.on('message', (data) => {\n      const message = decode(data);\n      if (message instanceof CredentialsResponse) {\n        this.emit('credentialsResponse', message.value.success, message.value.code, message.value.message);\n      } else if (message instanceof PeerResponse) {\n        this.emit('peerResponse', message.value.id, message.value.success, message.value.code, message.value.message);\n      } else {\n        this.emit('message', message);\n      }\n    });\n\n    await new Promise((resolve, reject) => {\n      const onOpen = () => {\n        this.removeListener('error', onError);\n        resolve();\n      };\n      const onError = (error: Error) => {\n        this.removeListener('open', onOpen);\n        reject(error);\n      };\n      this.once('error', onError);\n      this.once('open', onOpen);\n    });\n    if (this.credentials) {\n      await this.sendCredentials(this.credentials);\n    }\n    const peerId = await this.sendPeerRequest();\n    return peerId;\n  }\n\n  async close(code?: number, reason?: string) {\n    const ws = this.ws;\n    if (!ws) {\n      throw new Error('Unable to close, socket does not exist');\n    }\n    await new Promise((resolve, reject) => {\n      const onClose = () => {\n        this.removeListener('error', onError);\n        resolve();\n      };\n      const onError = (error: Error) => {\n        this.removeListener('close', onClose);\n        reject(error);\n      };\n      this.once('error', onError);\n      this.once('close', onClose);\n      ws.close(code, reason);\n    });\n  }\n\n  async sendCredentials(credentials: Object) {\n    const ws = this.ws;\n    if (!ws) {\n      throw new Error('Unable to send credentials, not open');\n    }\n    await new Promise((resolve, reject) => {\n      const handleClose = () => {\n        clearTimeout(timeout);\n        this.removeListener('close', handleClose);\n        this.removeListener('credentialsResponse', handleCredentialsResponse);\n        reject(new CloseError('Connection closed before credentials response was received'));\n      };\n      const handleCredentialsResponse = (success, code, message) => {\n        clearTimeout(timeout);\n        this.removeListener('close', handleClose);\n        this.removeListener('credentialsResponse', handleCredentialsResponse);\n        if (success) {\n          resolve();\n        } else {\n          reject(new CredentialsError(message, code));\n        }\n      };\n      const timeout = setTimeout(() => {\n        this.removeListener('credentialsResponse', handleCredentialsResponse);\n        reject(new CredentialsError(`Credentials response timeout after ${Math.round(this.timeoutDuration / 100) / 10} seconds`, 504));\n      }, this.timeoutDuration);\n      this.on('close', handleClose);\n      this.on('credentialsResponse', handleCredentialsResponse);\n      ws.send(encode(new Credentials(credentials)));\n    });\n  }\n\n  sendPeerRequest():Promise<number> {\n    const ws = this.ws;\n    if (!ws) {\n      throw new Error('Unable to peer, not open');\n    }\n    return new Promise((resolve, reject) => {\n      const handleClose = () => {\n        clearTimeout(timeout);\n        this.removeListener('close', handleClose);\n        this.removeListener('peerResponse', handlePeerResponse);\n        reject(new CloseError('Connection closed before peer response was received'));\n      };\n      const handlePeerResponse = (id, success, code, message) => {\n        clearTimeout(timeout);\n        this.removeListener('close', handleClose);\n        this.removeListener('peerResponse', handlePeerResponse);\n        if (success) {\n          resolve(id);\n        } else {\n          reject(new PeerError(message, code, id));\n        }\n      };\n      const timeout = setTimeout(() => {\n        this.removeListener('peerResponse', handlePeerResponse);\n        reject(new PeerError(`Peer response timeout after ${Math.round(this.timeoutDuration / 100) / 10} seconds`, 504));\n      }, this.timeoutDuration);\n      this.on('close', handleClose);\n      this.on('peerResponse', handlePeerResponse);\n      ws.send(encode(new PeerRequest(this.id)));\n    });\n  }\n\n  unpeer() {\n    const ws = this.ws;\n    if (!ws) {\n      throw new Error('Unable to unpeer, not open');\n    }\n    ws.send(encode(new Unpeer()));\n  }\n\n  declare id:number;\n  declare address:string;\n  declare maxPayloadLength: number;\n  declare credentials: Object;\n  declare ws: void | WS;\n  declare timeoutDuration: number;\n}\n\n"],"file":"peer-connection.js"}