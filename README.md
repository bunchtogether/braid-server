# Braid Server

[![CircleCI](https://circleci.com/gh/bunchtogether/braid-server.svg?style=svg)](https://circleci.com/gh/bunchtogether/braid-server) [![npm version](https://badge.fury.io/js/%40bunchtogether%2Fbraid-server.svg)](http://badge.fury.io/js/%40bunchtogether%2Fbraid-server) [![codecov](https://codecov.io/gh/bunchtogether/braid-server/branch/master/graph/badge.svg)](https://codecov.io/gh/bunchtogether/braid-server)

WebSocket-based key-value synchronization.

See also:

-   [Client](https://github.com/bunchtogether/braid-client-js)
-   [MessagePack Definitions](https://github.com/bunchtogether/braid-messagepack)

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [Server](#server)
    -   [Parameters](#parameters)
    -   [throwOnLeakedReferences](#throwonleakedreferences)
    -   [publishToPeers](#publishtopeers)
        -   [Parameters](#parameters-1)
    -   [sendToPeer](#sendtopeer)
        -   [Parameters](#parameters-2)
    -   [setCredentialsHandler](#setcredentialshandler)
        -   [Parameters](#parameters-3)
    -   [setPeerRequestHandler](#setpeerrequesthandler)
        -   [Parameters](#parameters-4)
    -   [setSubscribeRequestHandler](#setsubscriberequesthandler)
        -   [Parameters](#parameters-5)
    -   [setEventSubscribeRequestHandler](#seteventsubscriberequesthandler)
        -   [Parameters](#parameters-6)
    -   [setPublishRequestHandler](#setpublishrequesthandler)
        -   [Parameters](#parameters-7)
    -   [handleCredentialsRequest](#handlecredentialsrequest)
        -   [Parameters](#parameters-8)
    -   [handlePeerRequest](#handlepeerrequest)
        -   [Parameters](#parameters-9)
    -   [handleSubscribeRequest](#handlesubscriberequest)
        -   [Parameters](#parameters-10)
    -   [handleEventSubscribeRequest](#handleeventsubscriberequest)
        -   [Parameters](#parameters-11)
    -   [handlePublishRequest](#handlepublishrequest)
        -   [Parameters](#parameters-12)
    -   [handleMessage](#handlemessage)
        -   [Parameters](#parameters-13)
    -   [publishEvent](#publishevent)
        -   [Parameters](#parameters-14)
    -   [publishData](#publishdata)
        -   [Parameters](#parameters-15)
    -   [addEventSubscription](#addeventsubscription)
        -   [Parameters](#parameters-16)
    -   [removeEventSubscription](#removeeventsubscription)
        -   [Parameters](#parameters-17)
    -   [removeEventSubscriptions](#removeeventsubscriptions)
        -   [Parameters](#parameters-18)
    -   [addPublisher](#addpublisher)
        -   [Parameters](#parameters-19)
    -   [removePublisher](#removepublisher)
        -   [Parameters](#parameters-20)
    -   [removePublishers](#removepublishers)
        -   [Parameters](#parameters-21)
    -   [addSubscription](#addsubscription)
        -   [Parameters](#parameters-22)
    -   [removeSubscription](#removesubscription)
        -   [Parameters](#parameters-23)
    -   [removeSubscriptions](#removesubscriptions)
        -   [Parameters](#parameters-24)
    -   [assignProvider](#assignprovider)
        -   [Parameters](#parameters-25)
    -   [provide](#provide)
        -   [Parameters](#parameters-26)
    -   [unprovide](#unprovide)
        -   [Parameters](#parameters-27)
    -   [assignReceiver](#assignreceiver)
        -   [Parameters](#parameters-28)
    -   [unassignReceiver](#unassignreceiver)
        -   [Parameters](#parameters-29)
    -   [handlePublisherOpen](#handlepublisheropen)
        -   [Parameters](#parameters-30)
    -   [handlePublisherClose](#handlepublisherclose)
        -   [Parameters](#parameters-31)
    -   [receive](#receive)
        -   [Parameters](#parameters-32)
    -   [unreceive](#unreceive)
        -   [Parameters](#parameters-33)
    -   [updatePeers](#updatepeers)
    -   [connectedPeers](#connectedpeers)
        -   [Parameters](#parameters-34)
    -   [prunePeers](#prunepeers)
    -   [removePeer](#removepeer)
        -   [Parameters](#parameters-35)
    -   [addPeer](#addpeer)
        -   [Parameters](#parameters-36)
    -   [close](#close)
    -   [connectToPeer](#connecttopeer)
        -   [Parameters](#parameters-37)
    -   [disconnectFromPeer](#disconnectfrompeer)
        -   [Parameters](#parameters-38)
    -   [reconnectToPeer](#reconnecttopeer)
        -   [Parameters](#parameters-39)
    -   [handlePeerSync](#handlepeersync)
        -   [Parameters](#parameters-40)
    -   [syncPeerConnection](#syncpeerconnection)
        -   [Parameters](#parameters-41)
    -   [syncPeerSocket](#syncpeersocket)
        -   [Parameters](#parameters-42)
    -   [hasPeer](#haspeer)
        -   [Parameters](#parameters-43)

### Server

**Extends EventEmitter**

Class representing a Braid Server

#### Parameters

-   `uwsServer` **UWSTemplatedApp** uWebSockets.js server
-   `websocketPattern` **UWSRecognizedString** uWebSockets.js websocket pattern (optional, default `'/*'`)
-   `websocketBehavior` **UWSWebSocketBehavior** uWebSockets.js websocket behavior and options (optional, default `{compression:0,maxPayloadLength:8*1024*1024,idleTimeout:10}`)

#### throwOnLeakedReferences

Throw an error if any internal data exists. Intended for tests and debugging.

Returns **void** 

#### publishToPeers

Publish objects to peers.

##### Parameters

-   `obj` **(ProviderDump | DataDump | ActiveProviderDump | ReceiverDump | PeerDump | PeerSubscriptionDump)** Object to send, should have "ids" property

Returns **void** 

#### sendToPeer

Send objects to a peer.

##### Parameters

-   `peerId` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Peer ID to send to
-   `obj` **(PublisherOpen | PublisherClose | PublisherPeerMessage)** Object to send

Returns **void** 

#### setCredentialsHandler

Set the credentials handler. The handler evaluates and modifies credentials provided by peers and clients when they are initially provided.

##### Parameters

-   `func`  

Returns **void** 

#### setPeerRequestHandler

Set the peer request handler. Approves or denies peer request handlers.

##### Parameters

-   `func`  

Returns **void** 

#### setSubscribeRequestHandler

Set the subscribe request handler. Approves or denies subscribe requests.

##### Parameters

-   `func`  

Returns **void** 

#### setEventSubscribeRequestHandler

Set the event subscribe request handler. Approves or denies event subscribe requests.

##### Parameters

-   `func`  

Returns **void** 

#### setPublishRequestHandler

Set the publish request handler. Approves or denies publish requests.

##### Parameters

-   `func`  

Returns **void** 

#### handleCredentialsRequest

Top level handler for incoming credentials messages. Uses the default/custom credentialsHandler method to validate.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID from which the credentials were received
-   `existingCredentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Existing credentials object
-   `clientCredentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Credentials object provided by the client

Returns **void** 

#### handlePeerRequest

Top level handler for incoming peer request messages. Uses the default/custom peerRequestHandler method to validate.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID from which the request was received
-   `credentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Credentials object
-   `peerId` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Peer ID provided by the client

Returns **void** 

#### handleSubscribeRequest

Top level handler for incoming subscribe request messages. Uses the default/custom subscribeRequestHandler method to validate.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID from which the request was received
-   `credentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Credentials object
-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key the subscriber is requesting updates on

Returns **void** 

#### handleEventSubscribeRequest

Top level handler for incoming event subscribe request messages. Uses the default/custom eventSubscribeRequestHandler method to validate.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID from which the request was received
-   `credentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Credentials object
-   `name` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Event name the subscriber is requesting updates on

Returns **void** 

#### handlePublishRequest

Top level handler for incoming publish request messages. Uses the default/custom publishRequestHandler method to validate.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID from which the request was received
-   `credentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Credentials object
-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key the publisher is requesting to publish to

Returns **void** 

#### handleMessage

Top level message handler, used by both sockets and connections.

##### Parameters

-   `message` **(DataDump | ProviderDump | ActiveProviderDump | PeerDump | PeerSubscriptionDump | PeerSync | PeerSyncResponse | BraidEvent)** Message to handle
-   `peerId`  

Returns **void** 

#### publishEvent

Publish event to subscribers.

##### Parameters

-   `name`  
-   `args`  
-   `id`  
-   `Event` **BraidEvent** object

Returns **void** 

#### publishData

Publish data to subscribers.

##### Parameters

-   `queue`  
-   `Data` **\[[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;any>, [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;any>]** dump queue.

Returns **void** 

#### addEventSubscription

Add an event subscription to a socket.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the subscriber
-   `name` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Name of the event to send

Returns **void** 

#### removeEventSubscription

Remove a subscription from a socket.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the subscriber
-   `name` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Name on which the subscriber should stop receiving events

Returns **void** 

#### removeEventSubscriptions

Remove all subscriptions from a socket, for example after the socket disconnects

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the subscriber

Returns **void** 

#### addPublisher

Add a publisher socket to a receiver.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the publisher
-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key to receive publisher messages

Returns **void** 

#### removePublisher

Remove a publisher socket from a receiver.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the publisher
-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key on which the publisher should stop sending updates

Returns **void** 

#### removePublishers

Remove all receivers from a publisher socket, for example after the socket disconnects

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the publisher

Returns **void** 

#### addSubscription

Add a subscription to a socket.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the subscriber
-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key to provide the subscriber with updates

Returns **void** 

#### removeSubscription

Remove a subscription from a socket.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the subscriber
-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key on which the subscriber should stop receiving updates

Returns **void** 

#### removeSubscriptions

Remove all subscriptions from a socket, for example after the socket disconnects

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the subscriber

Returns **void** 

#### assignProvider

Assign a provider to a key.

##### Parameters

-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key to provide peers with updates, which peers will then disseminate to subscribers

Returns **void** 

#### provide

Indicate this server instance is providing for keys matching the regex string.

##### Parameters

-   `regexString` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Regex to match keys with
-   `callback`  

Returns **void** 

#### unprovide

Indicate this server instance is no longer providing for keys matching the regex string.

##### Parameters

-   `regexString` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Regex to match keys with

Returns **void** 

#### assignReceiver

Assign a receiver to a key.

##### Parameters

-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key to for a socket to publish to, which peers will then disseminate to recivers
-   `socketId`  

Returns **void** 

#### unassignReceiver

Unassign a receiver to a key.

##### Parameters

-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key that the socket was publishing to
-   `socketId`  

Returns **void** 

#### handlePublisherOpen

Top level publisher open handler

##### Parameters

-   `peerId`  
-   `regexString`  
-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key the socket is publishing to
-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the peer
-   `credentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Credentials object

Returns **void** 

#### handlePublisherClose

Top level publisher close handler

##### Parameters

-   `key` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Key the socket is publishing to
-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the peer

Returns **void** 

#### receive

Indicate this server instance is receiving messages from publishers for keys matching the regex string.

##### Parameters

-   `regexString` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Regex to match keys with
-   `messageCallback`  
-   `openCallback`  
-   `closeCallback`  

Returns **void** 

#### unreceive

Indicate this server instance is no longer receiving from publishers for keys matching the regex string.

##### Parameters

-   `regexString` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Regex to match keys with

Returns **void** 

#### updatePeers

Update the peers Observed remove map with local peer IDs

Returns **void** 

#### connectedPeers

Traverse through the peers Observed remove map to find all peers through which the specified peer is connected to

##### Parameters

-   `id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID of the root peer
-   `peerIds` **[Set](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Set)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>** Set to add connected peers to. (Passed by reference.)

Returns **void** 

#### prunePeers

Traverse through connected peers and remove any peers without a direct path. Used after a peer disconnects.

Returns **void** 

#### removePeer

Removes a peer, reassigning any active providers.

##### Parameters

-   `peerId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID of the peer

Returns **void** 

#### addPeer

Adds a peer.

##### Parameters

-   `socketId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of the peer
-   `peerId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID of the peer

Returns **void** 

#### close

Stops the server by gracefully closing all sockets and outgoing connections

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;void>** 

#### connectToPeer

Connects to a peer

##### Parameters

-   `address` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Websocket URL of the peer
-   `credentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)?** Credentials to send during the peer request
-   `attempt` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)?** Number of previous reconnect attempts (optional, default `0`)

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>** 

#### disconnectFromPeer

Disconnect from a peer

##### Parameters

-   `peerId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;void>** 

#### reconnectToPeer

Send a peer sync message to an (outgoing) peer connection

##### Parameters

-   `peerId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID to reconnect to
-   `attempt` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)?** Number of previous reconnect attempts
-   `address` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Websocket URL of the peer
-   `credentials` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)?** Credentials to send during the peer reconnect request

Returns **void** 

#### handlePeerSync

Handle a peer sync message, updating all shared maps with the provided data

##### Parameters

-   `peerSync` **PeerSync** Peer sync object

Returns **void** 

#### syncPeerConnection

Send a peer sync message to an (outgoing) peer connection

##### Parameters

-   `peerId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID to send sync message to

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;void>** 

#### syncPeerSocket

Send a peer sync message to an (incoming) peer socket

##### Parameters

-   `socketId`  
-   `peerId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID to send sync message to
-   `socketID` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Socket ID of peer to send sync message to

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;void>** 

#### hasPeer

Check if peer exists

##### Parameters

-   `peerId` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Peer ID

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 
